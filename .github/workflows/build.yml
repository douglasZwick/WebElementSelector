name: Build Bookmarklet

on:                     # Change this if I want to trigger
  push:                 # this build via a push to a branch
    branches: [ main ]  # other than main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Check out main repo
      uses: actions/checkout@v4

    - name: Read build.config
      id: config
      run: |
        . build.config
        echo "repo=$module_repo" >> $GITHUB_OUTPUT
        echo "branch=$module_branch" >> $GITHUB_OUTPUT
        echo "path=$module_path" >> $GITHUB_OUTPUT
        
    - name: Fetch external module from ${{ steps.config.outputs.repo }}
      run: |
        mkdir -p src
        curl -L -o src/Module.js https://raw.githubusercontent.com/${{ steps.config.outputs.repo }}/${{ steps.config.outputs.branch }}/${{ steps.config.outputs.path }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install esbuild
      run: npm install esbuild

    - name: Bundle and minify with esbuild
      run: |
        mkdir -p dist
        npx esbuild src/Main.js --bundle --minify --outfile=dist/bookmarklet.raw.js
        echo -n "javascript:" > dist/bookmarklet.txt
        node -e "process.stdout.write(encodeURIComponent(require('fs').readFileSync('dist/bookmarklet.raw.js', 'utf8')))" >> dist/bookmarklet.txt
        
    - name: Commit and push built bookmarklet
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add dist/
        git commit -m "Auto-build bookmarklet output" || echo "No changes to commit"
        git push
